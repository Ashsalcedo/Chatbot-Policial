<?php
session_start();

// webhook.php
require_once 'twilio_config.php';
require 'bd_config.php';
require 'vendor/autoload.php';

use Twilio\Rest\Client;



$twilio = new Client($sid, $token);

// Verificar si el n√∫mero de tel√©fono ya tiene sesi√≥n iniciada
$from = $_POST['From'];
$toBd = str_replace("whatsapp:", "", $from); // Para saber el n√∫mero de tel√©fono y verificarlo en la BD
$numOficial = str_replace("whatsapp:+521", "", $from); // Para saber el n√∫mero de tel√©fono y verificarlo en la BD

if (!isset($_SESSION[$toBd])) {
    // Si no existe la sesi√≥n para este n√∫mero, inicializar las variables necesarias
    $_SESSION[$toBd] = [
        'awaiting_unit_input' => false, // Esperando entrada de unidad
        'tipo_consulta' => null, // Guardar tipo de consulta (vehiculo o persona)
        'consul_activa' =>false,
        'referenciaS' =>null,
        'id_oficial' => null
    ];
}

// Guardar el estado actual de la sesi√≥n en un archivo para inspecci√≥n
file_put_contents(
    'session_debug.log',
    "Sesi√≥n para $toBd:\n" . print_r($_SESSION[$toBd], true) . "\n",
    FILE_APPEND
);

$ver = false;
$id_oficial;
$result;
$awaitingUnitInput = $_SESSION[$toBd]['awaiting_unit_input'];
$tipoConsulta = $_SESSION[$toBd]['tipo_consulta']; // Tipo de consulta (vehiculo o persona)
$referenciaSol = $_SESSION[$toBd]['referenciaS']; //Verifica si hay una consulta en curso //Sera cambiado por la variable de la BD


if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $body = strtolower(trim($_POST['Body'])); // Convertir el mensaje a min√∫sculas y eliminar espacios en blanco

    $sendSecondMessage = false; // Controlar si se debe enviar un segundo mensaje
    $secondMessage = ""; // Contenido del segundo mensaje
    $sendThirdMessage = false; // Controlar si se debe enviar un tercero mensaje
    $thirdMessage = ""; // Contenido del tercero mensaje

    // Conectar a la base de datos
    $conexion = mysqli_connect($host, $username, $password) or die ("Error en la conexi√≥n.");

    if ($conexion) {
        mysqli_select_db($conexion, $dbname) or die ("ERROR db");

        // Consulta SQL para obtener el valor de verificado_oficial
        $query = 'SELECT * FROM oficiales WHERE telefono_oficial = "'.$numOficial.'" ';
        $resul = mysqli_query($conexion, $query) or die("Error query: " . mysqli_error($conexion));

        // Inicializar $result como null
        $result = null;

        // Obtener el resultado de la consulta
        if ($tupla = mysqli_fetch_array($resul)) {
            $result = $tupla['verificado_oficial'];
            $id_oficial = $tupla['id_oficial'];
        }

        // Cerrar conexi√≥n
        mysqli_close($conexion);
    }

    if (is_null($result)) {
        $responseMessage = "üö´ No se encontr√≥ el n√∫mero de tel√©fono en la base de datos. Por favor, intente nuevamente.".$toBd;
    } else {
        if($result === "1"){
            $ver = true;
        }else{
            $ver = false;
        }
        if (!$ver) {
            if ($body === 'si') {
                $responseMessage = "üìã Por favor, *copie el siguiente formato*, *complete la informaci√≥n requerida* y *env√≠alo* como mensaje para continuar. ¬°Gracias! üòä";
                $secondMessage = "Tel√©fono: \nUnidad: ";
                $sendSecondMessage = true;
                $_SESSION[$toBd]['awaiting_unit_input'] = true; // Cambiar estado para esperar el mensaje con "Unidad:"
            } elseif ($body === 'no') {
                $responseMessage = "Entendido. Si desea confirmar su identidad, por favor env√≠e un mensaje nuevamente. üòä";
            } else {
                if($awaitingUnitInput){
                    // Paso 1: Eliminar saltos de l√≠nea u otros caracteres innecesarios
                    $body = str_replace(["\n", "\r"], " ", $body); // Reemplaza los saltos de l√≠nea con un espacio

                    // Paso 2: Buscar la posici√≥n de la palabra "Unidad:"
                    $unidadPos = strpos(strtolower($body), 'unidad:'); // Convertimos todo a min√∫sculas para evitar errores de may√∫sculas/min√∫sculas
                    if($body === 'cancelar'){
                        $responseMessage = "üëå Entendido. Si decide confirmar su identidad m√°s tarde, solo env√≠e un mensaje nuevamente. ¬°Estamos aqu√≠ para ayudarte! üòä";
                        $_SESSION[$toBd]['awaiting_unit_input'] = false; 
                    }else{
                        // Paso 3: Si se encuentra la palabra "unidad:" en el mensaje
                        if ($unidadPos !== false) {
                            // Extraer el texto que sigue a "unidad:", ignorando espacios adicionales
                            $unitData = trim(substr($body, $unidadPos + strlen('unidad:'))); // Extraemos todo despu√©s de "unidad:"

                            // Verificar si hay contenido despu√©s de "unidad:"
                            if (!empty($unitData)) {
                                // Aqu√≠ se har√≠a la verificaci√≥n en la base de datos
                                $responseMessage = "‚ú® Gracias. Estamos en proceso de verificar sus datos. Por favor, espere un momento mientras completamos la validaci√≥n. ‚è≥";
                                //$_SESSION[$toBd]['awaiting_unit_input'] = false; 
                                
                                /**Chequeo de datos para hacer verificaci√≥n*/
                                // Conectar a la base de datos
                                $conexion = mysqli_connect($host, $username, $password) or die ("Error en la conexi√≥n.");

                                if ($conexion) {
                                    mysqli_select_db($conexion, $dbname) or die ("ERROR db");

                                    // Consulta SQL para obtener el valor de verificado_oficial
                                    $query = 'SELECT * FROM oficiales WHERE telefono_oficial = "'.$numOficial.'" AND unidad_oficial = '.$unitData.'';
                                    $resul = mysqli_query($conexion, $query) or die("Error query: " . mysqli_error($conexion));

                                    // Obtener el resultado de la consulta
                                    if ($tupla = mysqli_fetch_array($resul)) {
                                        $sendSecondMessage = true;
                                        $secondMessage = "‚úÖ ¬°Verificaci√≥n exitosa! üéâ Sus datos han sido confirmados *correctamente*. Gracias por su paciencia. üòä";
                                        $sendThirdMessage = true;
                                        $thirdMessage = "üìå *Instrucciones de uso*:\n- üÜò *Ayuda*: Obt√©n informaci√≥n sobre c√≥mo usar este bot.\n- üîÑ *Inicio*: Inicia una nueva consulta.\n- ‚ùå *Cancelar*: Cancela su consulta si a√∫n no ha sido asignada a un analista.\n‚ö†Ô∏è *Nota*: Solo puedes iniciar una nueva consulta una vez que la actual haya sido resuelta por un analista. üòä";
                                        /**Subida de datos a la BD */
                                        $conexion = mysqli_connect($host, $username, $password) or die ("Error en la conexi√≥n.");
                                        $query = 'UPDATE oficiales SET verificado_oficial = 1 WHERE telefono_oficial = "'.$numOficial.'" ';
                                        mysqli_select_db($conexion, $dbname) or die("ERROR en base de datos");
                                        mysqli_query($conexion, $query);
                                    }else{
                                        $responseMessage = "‚ö†Ô∏è Por favor, verifique que los datos proporcionados sean correctos e int√©ntelo nuevamente. \n\nSi desea cancelar la verificaci√≥n, env√≠e un mensaje con la palabra *cancelar*. üòä";
                                    }
                                    // Cerrar conexi√≥n
                                    mysqli_close($conexion);
                                }
                            }else {
                                $responseMessage = "‚ö†Ô∏è Por favor, verifique que los datos proporcionados sean correctos e int√©ntelo nuevamente. \n\nSi desea cancelar la verificaci√≥n, env√≠e un mensaje con la palabra *cancelar*. üòä";
                            }
                        } else {
                            $responseMessage = "üö´ No pudimos encontrar todos los datos necesarios en su mensaje. Por favor, rev√≠selo y vuelva a intentarlo. \n\nSi desea cancelar la verificaci√≥n, simplemente env√≠e un mensaje con la palabra *cancelar*. üòä";
                        }
                    }
                }else {
                    $responseMessage = "‚ö†Ô∏è *Atenci√≥n:* Su identidad a√∫n no ha sido verificada. ¬øLe gustar√≠a intentarlo ahora?\n\n" . 
                    "Por favor, responda con la palabra *s√≠* o *no* para continuar. ‚úÖ‚ùå";
                }
            }
        }else{
            // Conectar a la base de datos para obtener el tel√©fono del oficial
            $conexion = mysqli_connect($host, $username, $password, $dbname) or die("Error en la conexi√≥n.");

            $query = "SELECT estado FROM solicitudes WHERE referenciaS = '".$referenciaSol."'";
            $result = mysqli_query($conexion, $query) or die("Error en la consulta: " . mysqli_error($conexion));
            $data = mysqli_fetch_array($result);
            $estado = $data['estado'];
            
            if($estado === '5'){
                $_SESSION[$toBd]['awaiting_unit_input'] = true; // Cambiar estado
                $_SESSION[$toBd]['consul_activa'] = true; // Cambiar estado
                $consul_activa = true;
                $awaitingUnitInput=true;
            }else if($estado === '3'){
                $_SESSION[$toBd]['awaiting_unit_input'] = false; // Cambiar estado
                $_SESSION[$toBd]['consul_activa'] = false; // Cambiar estado
                $_SESSION[$toBd]['referenciaS'] = null;
                $consul_activa = false;
                $awaitingUnitInput=false;

            }else{
                $consul_activa = $_SESSION[$toBd]['consul_activa']; //Verifica si hay una consulta en curso //Sera cambiado por la variable de la BD
            }
            // Cerrar la conexi√≥n
            mysqli_close($conexion);

            $lines = explode("\n", $body);
            // Verificar si la primera l√≠nea contiene "Seguimiento Personas" o "Seguimiento Veh√≠culo"
            $firstLine = strtolower(trim($lines[0])); // Convertir a min√∫sculas y eliminar espacios

            if ($firstLine === strtolower("Seguimiento Personas")) {
                // Normalizar texto: reemplazar espacios no est√°ndar y eliminar caracteres innecesarios
                $body = preg_replace('/\x{00A0}+/u', ' ', $body); // Reemplaza espacios no separaci√≥n (\u00A0) con espacios regulares
                $body = trim($body); // Elimina espacios en blanco adicionales al inicio y final

                // Expresiones regulares para capturar los nuevos campos
                $patternUbicacion = '/^Ubicaci√≥n actual:\s*(.*?)\s*(?:\n|$)/im';
                $patternColonia = '/^Colonia actual:\s*(.*?)\s*(?:\n|$)/im';
                $patternSector = '/^Sector:\s*(.*?)\s*(?:\n|$)/im';
                $patternEdad = '/^Edad:\s*(.*?)\s*(?:\n|$)/im';
                $patternNacionalidad = '/^Nacionalidad:\s*(.*?)\s*(?:\n|$)/im';
                $patternDomicilio = '/^Domicilio detenido:\s*(.*?)\s*(?:\n|$)/im';

                // Variables para almacenar los valores extra√≠dos
                $ubicacionActual = $coloniaActual = $sector = $edad = $nacionalidad = $domicilioDetenido = null;

                // Ejecutar las expresiones regulares para cada campo
                if (preg_match($patternUbicacion, $body, $matches)) {
                    $ubicacionActual = trim($matches[1]);
                }
                if (preg_match($patternColonia, $body, $matches)) {
                    $coloniaActual = trim($matches[1]);
                }
                if (preg_match($patternSector, $body, $matches)) {
                    $sector = trim($matches[1]);
                }
                if (preg_match($patternEdad, $body, $matches)) {
                    $edad = trim($matches[1]);
                }
                if (preg_match($patternNacionalidad, $body, $matches)) {
                    $nacionalidad = trim($matches[1]);
                }
                if (preg_match($patternDomicilio, $body, $matches)) {
                    $domicilioDetenido = trim($matches[1]);
                }

                // Validar campos vac√≠os o malformados
                $missingFields = [];

                // Funci√≥n para verificar si un campo contiene palabras clave de otros campos
                function containsInvalidValue($value) {
                    $invalidKeywords = ['Ubicaci√≥n actual:', 'Colonia actual:', 'Sector:', 'Edad:', 'Nacionalidad:', 'Domicilio detenido:'];
                    foreach ($invalidKeywords as $keyword) {
                        if (stripos($value, $keyword) !== false) {
                            return true;
                        }
                    }
                    return false;
                }

                // Validar cada campo
                if (empty($ubicacionActual) || ctype_space($ubicacionActual) || containsInvalidValue($ubicacionActual)) $missingFields[] = "*Ubicaci√≥n actual*";
                if (empty($coloniaActual) || ctype_space($coloniaActual) || containsInvalidValue($coloniaActual)) $missingFields[] = "*Colonia actual*";
                if (empty($sector) || ctype_space($sector) || containsInvalidValue($sector)) $missingFields[] = "*Sector*";
                if (empty($edad) || ctype_space($edad) || containsInvalidValue($edad)) $missingFields[] = "*Edad*";
                if (empty($nacionalidad) || ctype_space($nacionalidad) || containsInvalidValue($nacionalidad)) $missingFields[] = "*Nacionalidad*";
                if (empty($domicilioDetenido) || ctype_space($domicilioDetenido) || containsInvalidValue($domicilioDetenido)) $missingFields[] = "*Domicilio detenido*";

                // Generar respuesta seg√∫n los campos validados
                if (!empty($missingFields)) {
                    // Mensaje de error indicando los campos faltantes o malformados
                    $responseMessage = "‚ùå *Error: Informaci√≥n incompleta o malformada.*\n" . 
                        "Por favor, aseg√∫rese de completar correctamente los siguientes campos:\n" . 
                        implode("\n", $missingFields) . "\n\n" . 
                        "Corrija el formulario y env√≠elo nuevamente.";
                } else {
                    /**
                     * Aqu√≠ es donde se sube todo a la base de datos
                     */

                    $fechaHoy = date('Y-m-d');
                    $conexion = mysqli_connect($host, $username, $password, $dbname) or die("Error de conexi√≥n: " . mysqli_connect_error());
                    //Se actualiza el estado de la solicitud
                    $query = 'UPDATE solicitudes SET estado = 3 WHERE referenciaS = '.$referenciaSol.'';
                    mysqli_query($conexion, $query);
                    $query = "INSERT INTO seguimientopersonas (referenciaP, id_oficial, fecha, ubicacion, colonia, sector, edad_detenido, nacionalidad_detenido, domicilio_detenido) 
                    VALUES ('".$referenciaSol."', '".$id_oficial."', '".$fechaHoy."', '".$ubicacionActual."', '".$coloniaActual."', '".$sector."', '".$edad."', '".$nacionalidad."', '".$domicilioDetenido."')";
                    mysqli_query($conexion, $query);
                    mysqli_close($conexion);

                    // Generar el mensaje de verificaci√≥n con todos los datos
                    $responseMessage = "‚úÖ *Verificaci√≥n de datos:*\n" . 
                        "- üìç *Ubicaci√≥n actual:* $ubicacionActual\n" . 
                        "- üèò *Colonia actual:* $coloniaActual\n" . 
                        "- üìå *Sector:* $sector\n" . 
                        "- üéÇ *Edad:* $edad\n" . 
                        "- üåé *Nacionalidad:* $nacionalidad\n" . 
                        "- üè† *Domicilio detenido:* $domicilioDetenido\n\n";
                    $sendSecondMessage = true;
                    $secondMessage = "¬°Gracias por la informaci√≥n ingresada! üôå\n" . 
                        "Su mensaje ha sido recibido con √©xito. El seguimiento sera realizado, puede realizar una nueva consulta mandando un mensaje con la palabra *Inicio*. ‚è≥\n" . 
                        "¬°Le agradecemos por su paciencia!";
                    $_SESSION[$toBd]['awaiting_unit_input'] = false; // Cambiar estado    
                    $_SESSION[$toBd]['consul_activa'] = false; // Cambiar estado
                    $_SESSION[$toBd]['referenciaS'] = null;
                }
            }elseif ($firstLine === strtolower("Seguimiento Veh√≠culo")){
                // Normalizar texto: reemplazar espacios no est√°ndar y eliminar caracteres innecesarios
                $body = preg_replace('/\x{00A0}+/u', ' ', $body); // Reemplaza espacios no separaci√≥n (\u00A0) con espacios regulares
                $body = trim($body); // Elimina espacios en blanco adicionales al inicio y final

                // Expresiones regulares para capturar los nuevos campos
                $patternUbicacion = '/^Ubicaci√≥n actual:\s*(.*?)\s*(?:\n|$)/im';
                $patternColonia = '/^Colonia actual:\s*(.*?)\s*(?:\n|$)/im';
                $patternSector = '/^Sector:\s*(.*?)\s*(?:\n|$)/im';
                $patternCaractVehiculo = '/^Caracter√≠sticas Veh√≠culo:\s*(.*?)\s*(?:\n|$)/im';
                $patternCondicionesVehiculo = '/^Condiciones Veh√≠culo:\s*(.*?)\s*(?:\n|$)/im';
                $patternNombreConductor = '/^Nombre conductor:\s*(.*?)\s*(?:\n|$)/im';

                // Variables para almacenar los valores extra√≠dos
                $ubicacionActual = $coloniaActual = $sector = $caracteristicasVehiculo = $condicionesVehiculo = $nombreConductor = null;

                // Ejecutar las expresiones regulares para cada campo
                if (preg_match($patternUbicacion, $body, $matches)) {
                    $ubicacionActual = trim($matches[1]);
                }
                if (preg_match($patternColonia, $body, $matches)) {
                    $coloniaActual = trim($matches[1]);
                }
                if (preg_match($patternSector, $body, $matches)) {
                    $sector = trim($matches[1]);
                }
                if (preg_match($patternCaractVehiculo, $body, $matches)) {
                    $caracteristicasVehiculo = trim($matches[1]);
                }
                if (preg_match($patternCondicionesVehiculo, $body, $matches)) {
                    $condicionesVehiculo = trim($matches[1]);
                }
                if (preg_match($patternNombreConductor, $body, $matches)) {
                    $nombreConductor = trim($matches[1]);
                }

                // Validar campos vac√≠os o malformados
                $missingFields = [];

                // Funci√≥n para verificar si un campo contiene palabras clave de otros campos
                function containsInvalidValue($value) {
                    $invalidKeywords = ['Ubicaci√≥n actual:', 'Colonia actual:', 'Sector:', 'Caracter√≠sticas Veh√≠culo:', 'Condiciones Veh√≠culo:', 'Nombre conductor:'];
                    foreach ($invalidKeywords as $keyword) {
                        if (stripos($value, $keyword) !== false) {
                            return true;
                        }
                    }
                    return false;
                }

                // Validar cada campo
                if (empty($ubicacionActual) || ctype_space($ubicacionActual) || containsInvalidValue($ubicacionActual)) $missingFields[] = "*Ubicaci√≥n actual*";
                if (empty($coloniaActual) || ctype_space($coloniaActual) || containsInvalidValue($coloniaActual)) $missingFields[] = "*Colonia actual*";
                if (empty($sector) || ctype_space($sector) || containsInvalidValue($sector)) $missingFields[] = "*Sector*";
                if (empty($caracteristicasVehiculo) || ctype_space($caracteristicasVehiculo) || containsInvalidValue($caracteristicasVehiculo)) $missingFields[] = "*Caracter√≠sticas Veh√≠culo*";
                if (empty($condicionesVehiculo) || ctype_space($condicionesVehiculo) || containsInvalidValue($condicionesVehiculo)) $missingFields[] = "*Condiciones Veh√≠culo*";
                if (empty($nombreConductor) || ctype_space($nombreConductor) || containsInvalidValue($nombreConductor)) $missingFields[] = "*Nombre conductor*";

                // Generar respuesta seg√∫n los campos validados
                if (!empty($missingFields)) {
                    // Mensaje de error indicando los campos faltantes o malformados
                    $responseMessage = "‚ùå *Error: Informaci√≥n incompleta o malformada.*\n" . 
                        "Por favor, aseg√∫rese de completar correctamente los siguientes campos:\n" . 
                        implode("\n", $missingFields) . "\n\n" . 
                        "Corrija el formulario y env√≠elo nuevamente. üòä";
                } else {
                    /**
                     * Aqu√≠ es donde se sube todo a la base de datos
                     */
                    // Conexi√≥n a la base de datos
                    $fechaHoy = date('Y-m-d');
                    $conexion = mysqli_connect($host, $username, $password, $dbname) or die("Error de conexi√≥n: " . mysqli_connect_error());
                    //Se actualiza el estado de la solicitud
                    $query = 'UPDATE solicitudes SET estado = 3 WHERE referenciaS = '.$referenciaSol.'';
                    mysqli_query($conexion, $query);
                    $query = "INSERT INTO seguimientovehiculos (referenciaV, id_oficial, fecha, ubicacion, colonia, sector, caracteristicasV, condicionesV, nombre_conductor) 
                    VALUES (" . intval($referenciaSol) . ", " . intval($id_oficial) . ", '" . mysqli_real_escape_string($conexion, $fechaHoy) . "', '" . mysqli_real_escape_string($conexion, $ubicacionActual) . "', '" . mysqli_real_escape_string($conexion, $coloniaActual) . "', '" . mysqli_real_escape_string($conexion, $sector) . "', '" . mysqli_real_escape_string($conexion, $caracteristicasVehiculo) . "', '" . mysqli_real_escape_string($conexion, $condicionesVehiculo) . "', '" . mysqli_real_escape_string($conexion, $nombreConductor) . "')";
                    mysqli_query($conexion, $query);
                    // Consulta SQL preparada para evitar inyecciones SQL
                    mysqli_close($conexion);

                    // Generar el mensaje de verificaci√≥n con todos los datos
                    $responseMessage = "‚úÖ *Verificaci√≥n de datos:*\n" . 
                        "- üìç *Ubicaci√≥n actual:* $ubicacionActual\n" . 
                        "- üèò *Colonia actual:* $coloniaActual\n" . 
                        "- üìå *Sector:* $sector\n" . 
                        "- üöó *Caracter√≠sticas del veh√≠culo:* $caracteristicasVehiculo\n" . 
                        "- üîß *Condiciones del veh√≠culo:* $condicionesVehiculo\n" . 
                        "- üë§ *Nombre del conductor:* $nombreConductor\n\n";
                    $sendSecondMessage = true;
                    $secondMessage = "¬°Gracias por la informaci√≥n ingresada! üôå\n" . 
                        "Su mensaje ha sido recibido con √©xito. El seguimiento sera realizado, puede realizar una nueva consulta mandando un mensaje con la palabra *Inicio*. ‚è≥\n" . 
                        "¬°Le agradecemos por su paciencia!";
                    $_SESSION[$toBd]['awaiting_unit_input'] = false; // Cambiar estado
                    $_SESSION[$toBd]['consul_activa'] = false; // Cambiar estado
                    $_SESSION[$toBd]['referenciaS'] = null;
                }
            }else{
                // Mensaje cuando ya est√° verificado
                if($consul_activa){
                    $responseMessage = "üö® ¬°Atenci√≥n! üö®\n" .
                        "Actualmente tienes una consulta activa. üïí Por favor, espera a que sea resuelta antes de iniciar una nueva. üòä\n" .
                        "¬°Gracias por tu comprensi√≥n y paciencia!";
                }else{
                    if ($body === 'inicio' && !$awaitingUnitInput) {
                        $responseMessage = "¬°Hola! üòÅ ¬øEn que puedo ayudarte?";
                        $sendSecondMessage = true;
                        $secondMessage = "Para realizar una consulta referente a un vehiculo mande un mensaje con la palabra: \nüöó *Vehiculo*";
                        $sendThirdMessage = true;
                        $thirdMessage = "Para realizar una consulta referente a una persona mande un mensaje con la palabra: \nüë®üë© *Persona*";
                    } elseif (($body === 'veh√≠culo' || $body === 'vehiculo') && /*!$_SESSION[$toBd]['awaiting_unit_input']*/!$awaitingUnitInput){
                        // Si selecciona "vehiculo"
                        $_SESSION[$toBd]['tipo_consulta'] = 'vehiculo'; // Guardar tipo de consulta
                        $_SESSION[$toBd]['awaiting_unit_input'] = true; // Cambiar estado para esperar el mensaje con "Unidad:"
                        $responseMessage = "Por favor, *copie y llene* el siguiente formato con los datos del veh√≠culo:\n" .
                        "Una vez completado, *env√≠alo como mensaje*. üòä";            
                        $sendSecondMessage = true;
                        $secondMessage = "Motivo:\nNo. Serie:\nPlaca:\nNombre sospechoso:";
                        $sendThirdMessage = true;
                        $thirdMessage = "üîî *Recordatorio importante:* üîî\n" .
                        "Si cometio un error o desea cancelar la consulta en cualquier momento, solo env√≠e la palabra *cancelar* y lo haremos por usted. ‚ùåüòä";

                        /**
                         * Aqui se crea la referencia de la consulta
                         * se guarda el telefono del oficial 
                         * y se pone el estado de la solicitud (Enviada, en proceso, resuelta, seguimiento)
                         * 
                         * */ 
                        /**
                         * motivo_consulta
                         * no_serie
                         * placa
                         */
                    } elseif ($body === 'persona') {
                        // Si selecciona "persona"
                        $_SESSION[$toBd]['tipo_consulta'] = 'persona'; // Guardar tipo de consulta
                        $_SESSION[$toBd]['awaiting_unit_input'] = true; // Cambiar estado para esperar el mensaje 
                        $responseMessage = "Por favor, *copie y llene* el siguiente formato con los datos del sospechoso:\n" .
                        "Una vez completado, *env√≠alo como mensaje*. üòä\n".
                        "*Importante:* La fecha de nacimiento debe tener el formato *DD/MM/AAAA*";
                        $sendSecondMessage = true;
                        $secondMessage = "Motivo:\nNombre:\nApellido Paterno:\nApellido Materno:\nFecha de nacimiento:";
                        $sendThirdMessage = true;
                        $thirdMessage = "üîî *Recordatorio importante:* üîî\n" .
                        "Si cometio un error o desea cancelar la consulta en cualquier momento, solo env√≠e la palabra *cancelar* y lo haremos por usted. ‚ùåüòä";
                        /**
                         * Aqui se crea la referencia de la consulta
                         * se guarda el telefono del oficial 
                         * y se pone el estado de la solicitud (Enviada, en proceso, resuelta, seguimiento)
                         * 
                         * */ 
                        /**
                         * motivo_consulta
                         * nombre_sospechoso
                         * ap_sospechoso
                         * am_sospechoso
                         * fecha_Nacimiento_Sospechoso
                         */
                    } else if($body === 'ayuda'){
                        $responseMessage = "üëã ¬°Hola! Aqu√≠ tienes c√≥mo usar este bot:\n\n" .
                        "- ‚ú® *Ayuda*: Obt√©n instrucciones para usar el bot.\n" .
                        "- üöÄ *Inicio*: Comienza una nueva consulta.\n" .
                        "- ‚ùå *Cancelar*: Cancela tu consulta (solo si a√∫n no est√° asignada a un analista).\n\n" .
                        "üìù *¬øC√≥mo funciona?*\n" .
                        "1. Escribe *Inicio* para comenzar.\n" .
                        "2. Elige entre:\n" .
                        "   - üöó *Veh√≠culo*\n" .
                        "   - üë§ *Persona*\n" .
                        "3. Recibir√°s un formulario. *C√≥pialo, compl√©talo y env√≠alo como mensaje*.\n\n" .
                        "üì© Tu consulta ser√° revisada por un analista.\n" .
                        "- Si se encuentra algo, te indicaremos los pasos a seguir.\n" .
                        "- Si no se encuentra nada, tendr√°s que llenar un nuevo formulario para dar seguimiento.\n\n" .
                        "‚ö†Ô∏è *Nota*: Solo podr√°s iniciar una nueva consulta despu√©s de que la actual sea resuelta. üòä";

                    }else if($awaitingUnitInput) {
                        if($body === 'cancelar' && !$consul_activa){
                            $responseMessage = "Entendido. Si desea realizar una consulta, env√≠e un mensaje nuevamente. üòä";
                            $_SESSION[$toBd]['awaiting_unit_input'] = false; // Restablecer estado
                        }else if($tipoConsulta === 'vehiculo'){
                            // Normalizar texto: reemplazar espacios no est√°ndar y eliminar caracteres innecesarios
                            $body = preg_replace('/\x{00A0}+/u', ' ', $body); // Reemplaza espacios no separaci√≥n (\u00A0) con espacios regulares
                            $body = trim($body); // Elimina espacios en blanco adicionales al inicio y final

                            // Expresiones regulares para capturar cada campo
                            $patternMotivo = '/^Motivo:\s*(.*?)\s*(?:\n|$)/im';
                            $patternNoSerie = '/^No\. Serie:\s*(.*?)\s*(?:\n|$)/im';
                            $patternPlaca = '/^Placa:\s*(.*?)\s*(?:\n|$)/im';
                            $patternNombreSospechoso = '/^Nombre sospechoso:\s*(.*?)\s*(?:\n|$)/im'; // Nueva expresi√≥n para "Nombre sospechoso"

                            // Variables para almacenar los valores extra√≠dos
                            $motivo = $noSerie = $placa = $nombreSospechoso = null;

                            // Ejecutar las expresiones regulares para cada campo
                            if (preg_match($patternMotivo, $body, $matches)) {
                                $motivo = trim($matches[1]);
                            }

                            if (preg_match($patternNoSerie, $body, $matches)) {
                                $noSerie = trim($matches[1]);
                            }

                            if (preg_match($patternPlaca, $body, $matches)) {
                                $placa = trim($matches[1]);
                            }

                            if (preg_match($patternNombreSospechoso, $body, $matches)) { // Capturar "Nombre sospechoso"
                                $nombreSospechoso = trim($matches[1]);
                            }

                            // Validar campos vac√≠os o malformados
                            $missingFields = [];

                            // Funci√≥n para verificar si un campo contiene palabras clave de otros campos
                            function containsInvalidValue($value) {
                                $invalidKeywords = ['Motivo:', 'No. Serie:', 'Placa:', 'Nombre sospechoso:'];
                                foreach ($invalidKeywords as $keyword) {
                                    if (stripos($value, $keyword) !== false) {
                                        return true;
                                    }
                                }
                                return false;
                            }

                            // Validar cada campo
                            if (empty($motivo) || ctype_space($motivo) || containsInvalidValue($motivo)) $missingFields[] = "*Motivo*";
                            if (empty($noSerie) || ctype_space($noSerie) || containsInvalidValue($noSerie)) $missingFields[] = "*No. Serie*";
                            if (empty($placa) || ctype_space($placa) || containsInvalidValue($placa)) $missingFields[] = "*Placa*";
                            if (empty($nombreSospechoso) || ctype_space($nombreSospechoso) || containsInvalidValue($nombreSospechoso)) $missingFields[] = "*Nombre sospechoso*"; // Validar nuevo campo

                            // Generar respuesta seg√∫n los campos validados
                            if (!empty($missingFields)) {
                                // Mensaje de error indicando los campos faltantes o malformados
                                $responseMessage = "‚ùå *Error: Informaci√≥n incompleta o malformada.*\n" .
                                    "Por favor, aseg√∫rese de completar correctamente los siguientes campos:\n" .
                                    implode("\n", $missingFields) . "\n\n" .
                                    "Corrija el formulario y env√≠elo nuevamente. üòä\n\nRecuerde que puede cancelar su consulta enviando un mensaje con la palabra *cancelar*";
                            } else {
                                // Conexi√≥n a la base de datos
                                $conexion = mysqli_connect($host, $username, $password, $dbname) or die("Error de conexi√≥n: " . mysqli_connect_error());
                                // Insertar los datos en la tabla 'solicitudes'
                                $queryInsert = "INSERT INTO solicitudes (mensaje, telefono_oficial, estado) 
                                VALUES ('', '".$numOficial."', 1)";

                                if(mysqli_query($conexion, $queryInsert)){
                                    // Obtener el valor de referenciaS (llave primaria)
                                    $referenciaS = mysqli_insert_id($conexion);
                                    $query = "INSERT INTO consultavehiculos (id_oficial, referenciaS, motivo_consulta, no_serie, placa, nom_sospechoso) 
                                    VALUES ('".$id_oficial."', '".$referenciaS."', '".$motivo."', '".$noSerie."', '".$placa."', '".$nombreSospechoso."')";
                                    mysqli_query($conexion, $query);

                                    // Generar el mensaje de verificaci√≥n con todos los datos
                                    $responseMessage = "‚úÖ *Verificaci√≥n de datos:*\n" .
                                    "- üìã *Motivo:* $motivo\n" .
                                    "- üè∑ *No. Serie:* $noSerie\n" .
                                    "- üè∑ *Placa:* $placa\n" .
                                    "- üë§ *Nombre sospechoso:* $nombreSospechoso\n\n";
                                    $sendSecondMessage = true;
                                    $secondMessage = "¬°Gracias por tu consulta! üôå\n" . 
                                        "Su mensaje ha sido recibido con √©xito. Estamos procesando su solicitud y en breve recibir√° los resultados. ‚è≥\n" . 
                                        "¬°Le agradecemos por su paciencia!";
                                    $_SESSION[$toBd]['consul_activa'] = true; // Cambiar estado 
                                    $_SESSION[$toBd]['awaiting_unit_input'] =  false;
                                    $_SESSION[$toBd]['referenciaS'] = $referenciaS;
                                }else{
                                    $referenciaS = mysqli_insert_id($conexion);
                                    $responseMessage = "No se pudo realizar la subida de datos";
                                }
                                mysqli_close($conexion);  
                            }
                        }else if ($tipoConsulta === 'persona') {
                            //$body = "Motivo: Sospechoso raro\nNombre: Angel\nApellido Paterno: Hurtado\nApellido Materno: Salcedo\nFecha de nacimiento: 20/10/2001";
                            // Normalizar texto: reemplazar espacios no est√°ndar y eliminar caracteres innecesarios
                            $body = preg_replace('/\x{00A0}+/u', ' ', $body); // Reemplaza espacios de no separaci√≥n (\u00A0) con espacios regulares
                            $body = trim($body); // Elimina espacios en blanco adicionales al inicio y final

                            // Expresiones regulares para capturar cada campo
                            $patternMotivo = '/^Motivo:\s*(.*?)\s*(?:\n|$)/im';
                            $patternNombre = '/^Nombre:\s*(.*?)\s*(?:\n|$)/im';
                            $patternApellidoPaterno = '/^Apellido Paterno:\s*(.*?)\s*(?:\n|$)/im';
                            $patternApellidoMaterno = '/^Apellido Materno:\s*(.*?)\s*(?:\n|$)/im';
                            $patternFechaNacimiento = '/^Fecha de nacimiento:\s*(.*?)\s*(?:\n|$)/im';

                            // Variables para almacenar los valores extra√≠dos
                            $motivo = $nombre = $apellidoPaterno = $apellidoMaterno = $fechaNacimiento = null;

                            // Ejecutar las expresiones regulares para cada campo
                            if (preg_match($patternMotivo, $body, $matches)) {
                                $motivo = trim($matches[1]);
                            }

                            if (preg_match($patternNombre, $body, $matches)) {
                                $nombre = trim($matches[1]);
                            }

                            if (preg_match($patternApellidoPaterno, $body, $matches)) {
                                $apellidoPaterno = trim($matches[1]);
                            }

                            if (preg_match($patternApellidoMaterno, $body, $matches)) {
                                $apellidoMaterno = trim($matches[1]);
                            }

                            if (preg_match($patternFechaNacimiento, $body, $matches)) {
                                $fechaNacimiento = trim($matches[1]);
                            }

                            // Validar campos vac√≠os o malformados
                            $missingFields = [];

                            // Funci√≥n para verificar si un campo contiene palabras clave de otros campos
                            function containsInvalidValue($value) {
                                $invalidKeywords = ['Motivo:', 'Nombre:', 'Apellido Paterno:', 'Apellido Materno:', 'Fecha de nacimiento:'];
                                foreach ($invalidKeywords as $keyword) {
                                    if (stripos($value, $keyword) !== false) {
                                        return true;
                                    }
                                }
                                return false;
                            }

                            // Validar cada campo
                            if (empty($motivo) || ctype_space($motivo) || containsInvalidValue($motivo)) $missingFields[] = "*Motivo*";
                            if (empty($nombre) || ctype_space($nombre) || containsInvalidValue($nombre)) $missingFields[] = "*Nombre*";
                            if (empty($apellidoPaterno) || ctype_space($apellidoPaterno) || containsInvalidValue($apellidoPaterno)) $missingFields[] = "*Apellido Paterno*";
                            if (empty($apellidoMaterno) || ctype_space($apellidoMaterno) || containsInvalidValue($apellidoMaterno)) $missingFields[] = "*Apellido Materno*";
                            if (empty($fechaNacimiento) || ctype_space($fechaNacimiento) || containsInvalidValue($fechaNacimiento)) $missingFields[] = "*Fecha de nacimiento*";

                            // Generar respuesta seg√∫n los campos validados
                            if (!empty($missingFields)) {
                                // Mensaje de error indicando los campos faltantes o malformados
                                $responseMessage = "‚ùå *Error: Informaci√≥n incompleta o malformada.*\n" .
                                    "Por favor, aseg√∫rese de completar correctamente los siguientes campos:\n" .
                                    implode("\n", $missingFields) . "\n\n" .
                                    "Corrija el formulario y env√≠elo nuevamente. üòä\n\nRecuerde que puede cancelar su consulta enviando un mensaje con la palabra *cancelar*";
                            } else {
                                /**
                                 * Aqui va toda la subida de datos
                                 */

                                // Conexi√≥n a la base de datos
                                $conexion = mysqli_connect($host, $username, $password, $dbname) or die("Error de conexi√≥n: " . mysqli_connect_error());
                                // Insertar los datos en la tabla 'solicitudes'
                                $queryInsert = "INSERT INTO solicitudes (mensaje, telefono_oficial, estado) 
                                VALUES ('', '".$numOficial."', 1)";
                        
                                if(mysqli_query($conexion, $queryInsert)){
                                   // Obtener el valor de referenciaS (llave primaria)
                                    $referenciaS = mysqli_insert_id($conexion);
                                    $query = "INSERT INTO consultapersonas (id_oficial, referenciaS, motivo_consulta, nombre_sospechoso, ap_sospechoso, am_sospechoso, fechaNacimiento_sospechoso)
                                    VALUES ('" . $id_oficial . "', '" . $referenciaS . "', '" . $motivo . "', '" . $nombre . "', '" . $apellidoPaterno . "', '" . $apellidoMaterno . "', '" . $fechaNacimiento . "')";
                                    mysqli_query($conexion, $query);

                                    // Generar el mensaje de verificaci√≥n con todos los datos
                                    $responseMessage = "‚úÖ *Verificaci√≥n de datos:*\n" .
                                    "- üìã *Motivo:* $motivo\n" .
                                    "- üë§ *Nombre:* $nombre\n" .
                                    "- üè∑ *Apellido Paterno:* $apellidoPaterno\n" .
                                    "- üè∑ *Apellido Materno:* $apellidoMaterno\n" .
                                    "- üìÖ *Fecha de nacimiento:* $fechaNacimiento\n\n";
                                    $sendSecondMessage = true;
                                    $secondMessage = "¬°Gracias por su consulta! üôå\n" . 
                                    "Su mensaje ha sido recibido con √©xito. Estamos procesando su solicitud y en breve recibir√° los resultados. ‚è≥\n" . 
                                    "¬°Le agradecemos por su paciencia!";
                                    $_SESSION[$toBd]['consul_activa'] = true; // Cambiar estado
                                    $_SESSION[$toBd]['awaiting_unit_input'] =  false;
                                    $_SESSION[$toBd]['referenciaS'] = $referenciaS;
                                }else{
                                    $referenciaS = mysqli_insert_id($conexion);
                                    $responseMessage = "No se pudo realizar la subida de datos";
                                }
                                mysqli_close($conexion);   
                            }
                        }             
                    } else {
                        $responseMessage = "¬°Ups! üòÖ No pude entender su mensaje. No se preocupes, estamos aqu√≠ para ayudarte. ü§ñ Por favor, intente enviarlo de nuevo o escriba *Ayuda* para obtener instrucciones sobre c√≥mo utilizar el chatbot. ¬°Gracias por su paciencia! üôå";
                    }
                }      
            }
            
        }
    }  

    try {
        // Enviar el primer mensaje
        $twilio->messages->create(
            $from,
            [
                'from' => $twilioPhoneNumber,
                'body' => $responseMessage
            ]
        );

        // Enviar el segundo mensaje solo si es necesario
        if ($sendSecondMessage) {
            $twilio->messages->create(
                $from,
                [
                    'from' => $twilioPhoneNumber,
                    'body' => $secondMessage
                ]
            );
        }

        if ($sendThirdMessage) {
            $twilio->messages->create(
                $from,
                [
                    'from' => $twilioPhoneNumber,
                    'body' => $thirdMessage
                ]
            );
        }
        error_log("Mensaje(s) enviado(s) correctamente a $from");
    } catch (Exception $e) {
        error_log("Error al enviar el mensaje: " . $e->getMessage());
    }
} else {
    error_log("Solicitud no es POST");
}
?>
